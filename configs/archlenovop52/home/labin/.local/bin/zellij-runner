#!/usr/bin/env bash

# set -euo pipefail

# Get the layout directory
ZJ_LAYOUT_DIR=$(zellij setup --check |
    grep "LAYOUT DIR" - |
    grep -o '".*"' - | tr -d '"')

# Function to select or specify a new layout
select_layout() {
    if [[ -d "${ZJ_LAYOUT_DIR}" ]]; then
        ZJ_LAYOUT=$(find "${ZJ_LAYOUT_DIR}" -type f |
            sed 's|.*/||' |
            fzf --ansi --preview='' ||
            exit)
        if [ -n "${ZJ_LAYOUT}" ]; then
            echo "${ZJ_LAYOUT}"
        else
            echo "classic.kdl"
        fi
    fi
}

# Get the list of sessions
ZJ_SESSIONS=$(zellij list-sessions)

# Determine if attaching to an existing session or creating a new one
if [ -n "${ZJ_SESSIONS}" ]; then
    # Count the number of sessions
    NO_SESSIONS=$(echo "${ZJ_SESSIONS}" | wc -l)

    if [ "${NO_SESSIONS}" -eq 1 ]; then
        # A single session exists
        SESSION=$(echo "${ZJ_SESSIONS}" | head -n 1)
        echo "A single session exists: ${SESSION}"
        read -p "Press Enter to attach to the existing session or enter a new session name to create: " NEW_SESSION
        if [ -n "${NEW_SESSION}" ]; then
            LAYOUT=$(select_layout)
            zellij --layout "${ZJ_LAYOUT_DIR}/${LAYOUT}" --session "${NEW_SESSION}"
        else
            zellij attach $(echo "${SESSION}" | awk '{print $1}' | sed -e 's/\x1b\[[0-9;]*m//g')
        fi
    else
        # More than one session exists
        SESSION=$(echo "${ZJ_SESSIONS}" |
            fzf --ansi --preview='' --nth=1 --bind='enter:become(echo {1})' || true)
        if [ -n "${SESSION}" ]; then
            zellij attach "${SESSION}"
        else
            read -p "Enter new session name (leave empty for a random name): " NEW_SESSION
            if [ -n "${NEW_SESSION}" ]; then
                LAYOUT=$(select_layout)
                zellij --layout "${ZJ_LAYOUT_DIR}/${LAYOUT}" --session "${NEW_SESSION}"
            else
                LAYOUT=$(select_layout)
                zellij --layout "${ZJ_LAYOUT_DIR}/${LAYOUT}"
            fi
        fi
    fi
else
    # No sessions exist
    echo "No sessions exist. Creating a new session."
    read -p "Enter new session name (leave empty for a random name): " NEW_SESSION
    if [ -n "${NEW_SESSION}" ]; then
        LAYOUT=$(select_layout)
        zellij --layout "${ZJ_LAYOUT_DIR}/${LAYOUT}" --session "${NEW_SESSION}"
    else
        LAYOUT=$(select_layout)
        zellij --layout "${ZJ_LAYOUT_DIR}/${LAYOUT}"
    fi
fi
